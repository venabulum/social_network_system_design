# System Design социальной сети для [курса по System Design](https://balun.courses/courses/system_design)

## Функциональные требования

- ФТ1. Создание поста. Пост может содержать фото, описание, геолокацию.
- ФТ2. Поставить "лайк" под постом.
- ФТ3. Написать комментарий под постом.
- ФТ4. Подписаться на путешественника.
- ФТ5. Поиск популярных мест.
- ФТ6. Просмотр постов, связанных с найденными популярными местами.
- ФТ7. Просмотр ленты постов путешественников, на которых подписан пользователь.

## Нефункциональные требования

### Общее

- НФТ1. DAU 10 000 000
- НФТ2. Аудитория — страны СНГ, поддержка только русского языка.
- НФТ3. Поддержка мобильных устройств и десктопа.
- НФТ4. Предположительная активность:
  - Запись:
    - НФТ4.1. В среднем каждый пользователь добавляет 1 пост в месяц (0.03 в день).
    - НФТ4.2. В среднем каждый пользователь ставит 3 лайка в день.
    - НФТ4.3. В среднем каждый пользователь пишет 5 комментариев в день.
  - Чтение:
    - НФТ4.4. В среднем каждый пользователь просматривает 10 постов в день.
    - НФТ4.5. В среднем каждый пользователь просматривает 15 комментариев в день.
    - НФТ4.6. В среднем каждый пользователь подписывается на 7 человек в день.
    - НФТ4.7. В среднем каждый пользователь выполняет поиск популярных мест 1 раз в день.
    - НФТ4.8. В среднем каждый пользователь просматривает только одну страницу своей ленты в день.
- НФТ5. Данные храним всегда.
- НФТ6. Доступность системы 99.9%
- НФТ7. Предположительные ограничения:
    - НФТ7.1. В одном посте может быть не более одной фотографии размером до 1МБ (1024КБ).
    - НФТ7.2. В одном посте может быть описание длиной не более 600 символов (~1.1КБ).
    - НФТ7.3. Один комментарий не может превышать 300 символов (~0.5КБ).
    - НФТ7.4. Пользователь может быть подписан максимум на 1000 пользователей (и наоборот — на пользователя может быть подписано не более 1000 пользователей).
    - НФТ7.5. Пользователь может публиковать максимум 100 постов в день.
    - НФТ7.6. Пользователь может оставлять максимум 100 комментариев в день.
    - НФТ7.7. На одной странице ленты постов не более 10 постов.
    - НФТ7.8. На одной странице результатов поиска популярных мест не более 15 мест. Одно место в выдаче — это превью фотографии размером до 5КБ и короткое описание до 0.1КБ.
- НФТ8. Сезонность: в летние месяцы нагрузка увеличивается в два раза.
- НФТ9. Тайминги:
  - Запись:
    - НФТ9.1. Загрузка в пост фотографии размером 1МБ — 4 секунды.
    - НФТ9.2. Публикация поста (с предварительно загруженной в пост фотографией) — 1 секунда.
    - НФТ9.3. Публикация комментария — 1 секунда.
  - Чтение:
    - НФТ9.4. Загрузка ленты постов путешественников (до 10 постов) — 2 секунды.
    - НФТ9.5. Загрузка комментариев к посту (до 100 комментариев) — 1 секунда.
    - НФТ9.6. Поиск популярных мест — 3 секунды.

### RPS

- Посты:
  - Запись: 10000000 * 0.03 / 86400 = 3.5
  - Чтение*: 10000000 * 10 / 86400 = 1157
- Лайки: 
  - Запись: 10000000 * 3 / 86400 = 347
  - Чтение*: 10000000 * 10 / 86400 = 1157
- Комментарии:
  - Запись: 10000000 * 5 / 86400 = 579
  - Чтение: 10000000 * 15 / 86400 = 1736
- Поиск (чтение): 10000000 * 1 / 86400 = 116

### Трафик

- Посты: 
  - Запись:
    - Фото: 3.5 * 1024КБ = 3584КБ/с
    - Метаданные: 3.5 * 1.5КБ = 5,25КБ/с
  - Чтение*: 
    - Фото: 1157 * 1024КБ * 10 = 11.5ГБ/с
    - Метаданные: 1157 * 1.5КБ * 10 = 17МБ/с
- Лайки: 
   - Запись: 347 * 0.05КБ = 17КБ/с
   - Чтение*: 1157 * 0.05КБ * 10 = 578КБ/с
- Комментарии: 
  - Запись: 579 * 0.5КБ = 290КБ/с
  - Чтение: 1736 * 0.5КБ * 15 = 13020КБ/с (~13МБ/с)
- Поиск (чтение): 116 * 5.1КБ = 592КБ/с

\* считаем по количеству просматриваемых постов / страниц ленты (НФТ4.4 / НФТ4.8) с учётом количества постов в ленте на одной странице (НФТ7.7)

## Расчёты дисков

### Capacity на год

- Посты: (3584КБ/с + 5,25КБ/с) * 86400 * 365 = ~106ТБ
- Лайки: 17КБ/с * 86400 * 365 = ~0,5ТБ
- Комментарии: 290КБ/с * 86400 * 365 = ~8,5ТБ

### Traffic

- Посты: 3584КБ/с + 5,25КБ/с + 11.5ГБ/с + 17МБ/с = ~12ГБ/с
- Лайки: 17КБ/с + 578КБ/с = ~0,6МБ/с
- Комментарии: 290КБ/с + 13020КБ/с = ~13,5МБ/с

### IOPS

- Посты: ~1200
- Лайки: ~1500
- Комментарии: ~2300

### Total

У нас немного данных, но часть трафика и количество операций ввода-вывода большие.
Выбираем *SSD SATA диски для лайков и комментариев*, *для постов — SSD nVME*.
Объём одного диска отличается для каждой из категории данных:
- посты - 30ТБ
- лайки - 1ТБ
- комментарии - 4ТБ

Количество дисков округляем в большую сторону.

Disks_for_capacity
- посты: 106 / 30 = ~4
- лайки: 0.5 / 1 = ~1
- комментарии: 8.5 / 4 = ~3

Disks_for_throughput
- посты: 12 / 3 = ~4
- лайки: 0,6 / 500 = ~1
- комментарии: 13,5 / 500 = ~1

Disks_for_iops
- посты: 1200 / 10000 = ~1
- лайки: 1500 / 1000 = ~2
- комментарии: 2300 / 1000 = ~3

Disks 
- посты: max(ceil(4), ceil(4), ceil(1)) = 4 SSD nVME
- лайки: max(ceil(1), ceil(1), ceil(2)) = 2 SSD SATA
- комментарии: max(ceil(3), ceil(1), ceil(3)) = 3 SSD SATA